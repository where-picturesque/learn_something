### 渲染流程
渲染模块在执行过程中会被划分为很多子阶段，输入的 HTML 经过这些子阶段，最后输出像素。我们把这样的一个处理流程叫做**渲染流水线**

按照渲染的时间顺序，流水线可分为如下几个子阶段：构建 DOM 树、样式计算、布局阶段、分层、绘制、分块、光栅化和合成。
- 开始每个子阶段都有其输入的内容；
- 然后每个子阶段有其处理过程；
- 最终每个子阶段会生成输出内容。

#### 构建 DOM 树
渲染引擎中html解析器将 HTML 转换为浏览器能够理解的结构——DOM 树。几乎与HTML内容一样，但DOM是保存在内存中树状结构。

#### 样式计算
1. 渲染引擎将 CSS 文本转换为浏览器可以理解的结构——styleSheets。
2. 属性值的标准化操作
3. 计算出DOM树中每个节点的具体样式（继承规则和层叠规则）


#### 布局阶段
布局：计算DOM树中**可见元素**的几何位置

布局阶段需要完成两个任务：创建布局树和布局计算。
- 创建布局树：只包含可见元素布局树。（遍历可见节点加到布局数，忽略不可见节点如head、display:none）
- 布局计算

> 在执行布局操作的时候，会把布局运算的结果重新写回布局树中，所以布局树既是输入内容也是输出内容，这是布局阶段一个不合理的地方，因为在布局阶段并没有清晰地将输入内容和输出内容区分开来。针对这个问题，Chrome 团队正在重构布局代码，下一代布局系统叫 LayoutNG，试图更清晰地分离输入和输出，从而让新设计的布局算法更加简单。

#### 分层
渲染引擎需要为特定的节点生成专用的图层，并生成一棵对应的**图层树**（LayerTree）。没有单独图层则从属于父节点图层
创建新图层：
1. 拥有层叠上下文属性的元素
2. 需要剪裁(clip)的地方

如100*100的div 如果文字过多会产生裁剪，为文字部分单独创建一层，如果出现滚动条，滚动条也单独一层。

#### 图层绘制
渲染引擎将图层绘制拆分成很多小的**绘制指令**，按顺序组成待绘制列表。

#### 栅格化(raster)操作
**合成线程**完成绘制操作

1. 主线程将绘制列表提交给合成线程
2. 合成线程将图层划分为图块，大小通常为256*256、512*512。
3. 合成线程按视口附近的图块优先生成位图
4. 合成线程将图块提交给栅格化线程，进行栅格化处理即将图块转换为位图
5. 通常栅格化过程会使用GPU来加速生成，即快速栅格化/GPU栅格化。渲染进程将生成图块的指令发给GPU，在GPU生成位图并保存在GPU内存中。
6. 将结果返回给渲染进程的合成线程，加下来执行合成图层操作。


#### 合成和显示
1. 所有图块被栅格化后，合成线程生成绘制图块的指令（DrawQuad），将命令提交给浏览器进程。
2. 浏览器进程中的viz组件接受DrawQuad命令，更具命令生成将页面，保存在内存中显示到显示器上。


### 总结
1. 渲染进程将 HTML 内容转换DOM 树结构。
2. 渲染引擎将 CSS 样式表转化为styleSheets，计算出 DOM 节点的样式。
3. 创建布局树，并计算元素的布局信息。
4. 对布局树进行分层，并生成分层树。
5. 为每个图层生成绘制列表，并将其提交到合成线程。
6. 合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。
7. 合成线程发送绘制图块命令 DrawQuad 给浏览器进程。
8. 浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上。