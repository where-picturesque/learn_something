## 03 | HTTP请求流程：为什么很多站点第二次打开速度会很快？

![图片](https://user-images.githubusercontent.com/31262456/145748435-bcae9e46-df12-4ea8-8814-1bc0aa448793.png)

1. 构建请求，准备发起网络请求(请求行信息)GET /index.html HTTP1.1
2. 查找缓存，有缓存终止。
3. 准备ip、端口；无本地缓存时 经dns解析
4. 等待TCP队列（chrome同一域名同时只能有6个连接）
5. 建立TCP连接
6. 发起http请求（携带请求头行、请求头、请求体）
7. 服务器处理HTTP 请求流程

![图片](https://user-images.githubusercontent.com/31262456/145921750-016af60a-0202-4734-a5fd-cfe5c1068073.png)

服务器处理HTTP 请求流程：
1. 返回请求；响应行（协议版本、状态码）、响应头、响应体 
2. 重定向：响应头中的Location字段表明重定向地址，开始重新导航，重新开始步骤3
3. 断开TCP连接
![图片](https://user-images.githubusercontent.com/31262456/145921636-766005ea-b7d1-4418-ab22-33f50cb7266e.png)

一旦服务器向客户端返回了请求数据，它就要关闭 TCP 连接

如果浏览器或者服务器在其头信息中加入了：Connection:Keep-Alive 

TCP 连接在发送后将仍然保持打开状态，这样浏览器就可以继续通过同一个 TCP 连接发送请求。



## 04 | 导航流程
用户发出 URL 请求到页面开始解析的这个过程，就叫做导航。
![图片](https://user-images.githubusercontent.com/31262456/145748566-6806af55-ce75-400a-977d-35b11edcf747.png)
#### 用户输入
1、用户输入关键词，地址栏判断是搜索内容还是url地址。

搜索内容，会使用浏览器默认搜索引擎加上搜索内容合成url；
域名会加上协议（如https）合成完整的url。

#### URL 请求过程
2、然后按下回车。浏览器进程通过IPC（进程间通信）把url传给网络进程（网络进程接收到url才发起真正的网络请求）。

3、网络进程接收到url后，先查找是否缓存该资源。

有缓存，直接返回缓存的资源。

没有缓存。（进入真正的网络请求）。首先获取域名的IP，系统会首先自动从hosts文件中寻找域名对应的 IP 地址；如果没有，则系统会将网址提交 DNS 域名解析服务器进行 IP 地址的解析。和服务器建立TCP连接

4、利用IP地址和服务器建立TCP连接（3次握手）。

5、建立连接后，浏览器构建数据包（包含请求行，请求头，请求正文，并把该域名相关Cookie等数据附加到请求头），然后向服务器发送请求消息。

6、服务器接收到消息后根据请求信息构建响应数据（包括响应行，响应头，响应正文），然后发送回网络进程。

7、网络进程接收到响应数据后进行解析。

1. 检查状态码，如果是301/302，则需要重定向，从Location自动中读取地址，重新进行步骤3

2. 状态码为200 检查响应类型Content-Type。告诉浏览器服务器返回的数据是什么类型的。如果是下载文件类型 application/octet-stream将该请求提交给下载管理器，该导航流程结束，不再进行。

如果是网页类型，那么浏览器就要准备渲染页面了。

#### 准备渲染进程
打开一个新页面采用的渲染进程策略就是：
- 通常情况下，打开新的页面都会使用单独的渲染进程；
- 如果从 A 页面打开 B 页面，且 A 和 B 都属于同一站点（根域名+协议相同）的话，那么 B 页面复用 A 页面的渲染进程；
- 如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。


#### 提交导航
9、浏览器向渲染进程发起“提交导航”的消息，渲染进程接收到消息和网络进程建立传输数据的“管道”，网络进程将“文档”传输给渲染进程。

11、传输完毕，渲染进程会发出“确认提交”消息给浏览器进程。

12、浏览器在接收到“确认提交”消息后，更新浏览器界面状态（包括地址栏信息，仟前进后退历史，web页面和网站安全状态）。
![图片](https://user-images.githubusercontent.com/31262456/145748585-b513dfe2-2b28-46b0-ae3b-e9287c76c57a.png)
##### 导航阶段结束

#### 渲染阶段
13、渲染进程便开始页面解析和子资源加载。渲染完毕，渲染进程会发送一个消息给浏览器进程，浏览器接收到这个消息后会停止标签图标的加载动画。
